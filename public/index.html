<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image</title> 
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon/icon-512x512.png">

    <link rel="icon" href="favicon.ico" /> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        html, body {
            min-height: 100vh;
        }
        body {
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        #app-container {
            transition: justify-content 0.5s ease-in-out;
            width: 100%; 
        }
        #prompt-textarea {
            transition: height 0.2s ease-in-out;
            scrollbar-width: none; 
        }
        #prompt-textarea::-webkit-scrollbar {
            display: none; 
        }
        /* 隱藏縮圖列的捲軸 */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .image-transition {
            transition: opacity 0.4s ease-in-out;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        .radio-label {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            background-color: #374151; 
            color: #D1D5DB; 
            border: 1px solid #4B5563; 
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%; 
            text-align: center; 
        }
        input[type="radio"]:checked + .radio-label {
            background-color: #3B82F6; 
            color: #FFFFFF; 
            border-color: #2563EB; 
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        input[type="radio"]:focus-visible + .radio-label {
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
             outline: none;
        }
        /* 載入中的閃爍效果 */
        .loading-pulse {
            animation: pulse-bg 1.5s infinite;
        }
        @keyframes pulse-bg {
            0% { background-color: #1f2937; }
            50% { background-color: #374151; }
            100% { background-color: #1f2937; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200"> 

    <div id="app-container" class="w-full max-w-2xl min-h-screen flex flex-col items-center justify-center p-4"> 

        <div id="results-gallery" class="w-full mb-4 hidden flex flex-col gap-4"> 
            
            <!-- 主圖顯示區 -->
            <div id="image-display-wrapper" class="relative w-full max-h-[60vh] aspect-square bg-gray-800 rounded-2xl shadow-xl overflow-hidden group mx-auto flex items-center justify-center"> 
                
                <!-- 1. 生成進度圓環 (Generation Loader) - 懸浮在中央 -->
                <div id="generation-loader" class="absolute inset-0 flex flex-col items-center justify-center z-30 bg-black/60 backdrop-blur-sm hidden transition-opacity duration-300">
                    <div class="relative w-24 h-24">
                        <!-- 背景圓圈 -->
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" fill="transparent" stroke="#374151" stroke-width="8"></circle>
                            <!-- 進度圓圈 -->
                            <circle id="progress-ring" cx="50" cy="50" r="40" fill="transparent" stroke="#3B82F6" stroke-width="8" stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"></circle>
                        </svg>
                        <!-- 中間文字 -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="progress-percent" class="text-white text-lg font-bold font-mono">0%</span>
                        </div>
                    </div>
                    <p class="text-white mt-4 font-bold text-lg animate-pulse tracking-wider">AI 繪圖中...</p>
                </div>

                <!-- 2. 圖片讀取轉圈圈 (Image Loading Spinner) - 圖片下載時顯示 -->
                <div id="image-loader" class="absolute inset-0 flex flex-col items-center justify-center z-10 loading-pulse hidden">
                    <svg class="animate-spin h-10 w-10 text-blue-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-gray-400 text-sm">影像傳輸中...</span>
                </div>

                <img id="result-image" src="" alt="生成的圖片" class="w-full h-full object-contain image-transition opacity-0 z-0">

                <!-- 資訊與按鈕懸浮層 -->
                <div class="absolute top-0 left-0 w-full p-3 flex justify-between items-start opacity-0 group-hover:opacity-100 transition-opacity bg-gradient-to-b from-black/70 to-transparent z-20 pointer-events-none">
                    
                    <!-- 資訊顯示區 (Prompt, Size, Ratio) -->
                    <div class="flex flex-col gap-1 text-xs text-white max-w-[70%] drop-shadow-md pointer-events-auto">
                        <div class="flex gap-2">
                            <span id="meta-size" class="bg-gray-700/80 px-2 py-0.5 rounded backdrop-blur-sm"></span>
                            <span id="meta-ratio" class="bg-gray-700/80 px-2 py-0.5 rounded backdrop-blur-sm"></span>
                        </div>
                        <p id="meta-prompt" class="line-clamp-2 italic opacity-90 font-light"></p>
                    </div>

                    <!-- 按鈕區 -->
                    <div class="flex gap-2 pointer-events-auto">
                        <button id="download-btn" class="bg-black/50 text-white rounded-full p-2 hover:bg-black/75 transition backdrop-blur-sm" title="下載">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </button>
                        <button id="fullscreen-btn" class="bg-black/50 text-white rounded-full p-2 hover:bg-black/75 transition backdrop-blur-sm" title="全螢幕">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 新增：歷史圖片縮圖列 -->
            <div id="history-gallery-section" class="w-full flex items-center gap-3 bg-gray-800/50 p-2 rounded-xl backdrop-blur-sm border border-gray-700">
                <!-- 清除按鈕 (左側固定) -->
                <button id="clear-history-btn" class="flex-shrink-0 p-2.5 bg-red-900/30 hover:bg-red-900/60 text-red-200 rounded-lg transition border border-red-900/30 group relative" title="清除舊圖 (保留目前圖片)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                </button>
                <div class="h-8 w-[1px] bg-gray-700"></div> <!-- 分隔線 -->
                
                <!-- 縮圖列表 (可捲動) -->
                <div id="history-gallery-list" class="flex gap-2 overflow-x-auto scrollbar-hide w-full items-center">
                    <!-- JS 會動態插入縮圖 -->
                </div>
            </div>

            <div id="gallery-nav" class="flex justify-between items-center px-2">
                <button id="nav-left" class="p-2 rounded-full hover:bg-gray-800 transition disabled:opacity-30 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
                <span id="image-counter" class="text-sm text-gray-400 font-mono"></span>
                <button id="nav-right" class="p-2 rounded-full hover:bg-gray-800 transition disabled:opacity-30 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </button>
            </div>
        </div>
        
        <!-- 移除舊的線性進度條 #progress-container -->
        <p id="error-message" class="w-full text-center text-red-400 mt-2 hidden bg-red-900/20 p-2 rounded-lg"></p>

        <div id="input-hub" class="w-full"> 
            <div id="image-preview-container" class="flex gap-2 mb-2 ml-14 hidden">
                <div id="image-preview-wrapper-1" class="relative w-20 h-20 hidden">
                    <img id="image-preview-1" src="" alt="圖片預覽 1" class="w-full h-full object-cover rounded-lg shadow-md">
                    <button data-preview-id="1" class="remove-image-btn absolute -top-2 -right-2 bg-red-600 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold shadow hover:bg-red-700 transition">&times;</button>
                </div>
            </div>
            
            <div class="w-full bg-gray-800 border border-gray-700 rounded-2xl shadow-lg flex items-start p-2 gap-2">
                <button id="upload-btn-1" class="flex-shrink-0 p-3 rounded-full hover:bg-gray-700 transition" title="上傳圖片 (主圖)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
                <input type="file" id="image-upload-1" accept="image/png, image/jpeg, image/webp" class="hidden">
                
                <button id="ratio-btn" class="flex-shrink-0 p-3 rounded-full hover:bg-gray-700 transition" title="設定長寬比與尺寸">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                </button>
                
                <button id="settings-btn" class="flex-shrink-0 p-3 rounded-full hover:bg-gray-700 transition" title="設定生成模式">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>

                <textarea id="prompt-textarea" rows="1" placeholder="輸入提示詞..." class="flex-grow bg-transparent text-lg text-gray-100 placeholder-gray-500 p-3 resize-none outline-none overflow-y-auto" style="max-height: 200px;"></textarea>
                
                <button id="send-btn" class="flex-shrink-0 bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                </button>
            </div>
        </div>

    </div>

    <!-- Fullscreen Modal -->
    <div id="fullscreen-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 hidden transition-opacity">
        <div class="relative w-full h-full max-w-4xl max-h-[90vh] flex items-center justify-center">
            <button id="modal-close-btn" class="absolute -top-2 -right-2 md:top-2 md:right-2 z-10 bg-white text-black rounded-full p-1.5 shadow-lg hover:scale-110 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <button id="modal-download-btn" class="absolute top-2 left-2 z-10 bg-white/80 text-black rounded-full p-2 shadow-lg hover:bg-white transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </button>

            <img id="modal-image" src="" alt="全螢幕預覽" class="max-w-full max-h-full object-contain rounded-lg">
            
            <button id="modal-nav-left" class="absolute left-0 md:-left-12 p-2 rounded-full bg-white/30 hover:bg-white/50 transition disabled:opacity-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <button id="modal-nav-right" class="absolute right-0 md:-right-12 p-2 rounded-full bg-white/30 hover:bg-white/50 transition disabled:opacity-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>
        </div>
    </div>
    
    <!-- Settings Modal (保持不變) -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md"> 
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">設定</h2>
                <button id="settings-close-btn" class="p-1 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-3">生成模式</label>
                <fieldset class="grid grid-cols-1 gap-3" id="mode-selector"> 
                    <div>
                        <input type="radio" name="generation-mode" value="generate-default" id="mode-default" class="hidden" checked>
                        <label for="mode-default" title="imagen-4.0-generate-001" class="radio-label">Imagen 4.0 (標準)</label>
                    </div>
                    <div>
                        <input type="radio" name="generation-mode" value="generate-fast" id="mode-fast" class="hidden">
                        <label for="mode-fast" title="imagen-4.0-fast-generate-001" class="radio-label">Imagen 4.0 (高速)</label>
                    </div>
                    <div>
                        <input type="radio" name="generation-mode" value="generate-ultra" id="mode-ultra" class="hidden">
                        <label for="mode-ultra" title="imagen-4.0-ultra-generate-001" class="radio-label">Imagen 4.0 (Ultra)</label>
                    </div>
                    <div>
                        <input type="radio" name="generation-mode" value="upscale" id="mode-upscale" class="hidden">
                        <label for="mode-upscale" title="使用 Imagen 4.0 放大" class="radio-label">圖片放大</label>
                    </div>
                </fieldset>
            </div>

            <div class="mb-4" id="image-count-wrapper">
                <label for="image-count" class="block text-sm font-medium text-gray-300 mb-2">生成圖片數量 (1-4)</label>
                <input type="number" id="image-count" name="image-count" value="1" min="1" max="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white outline-none focus:ring-2 focus:ring-blue-500">
                <p id="image-count-note" class="text-xs text-gray-500 mt-1">注意：所有模型一次最多生成 4 張。</p>
            </div>
            
            <div class="mb-4 hidden" id="upscale-options-wrapper">
                <label class="block text-sm font-medium text-gray-300 mb-3">放大尺寸 (僅支援 2K / 4K)</label>
                <fieldset class="grid grid-cols-2 gap-3" id="upscale-level-selector"> 
                    <div>
                        <input type="radio" name="upscale-level-mode" value="2048" id="upscale-2k" class="hidden" checked>
                        <label for="upscale-2k" class="radio-label">2K (x2)</label>
                    </div>
                    <div>
                        <input type="radio" name="upscale-level-mode" value="4096" id="upscale-4k" class="hidden">
                        <label for="upscale-4k" class="radio-label">4K (x4)</label>
                    </div>
                </fieldset>
            </div>
            
        </div>
    </div>
    
    <!-- Ratio Modal (保持不變) -->
    <div id="ratio-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">長寬比與尺寸</h2>
                <button id="ratio-close-btn" class="p-1 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-3">長寬比例</label>
                <fieldset class="grid grid-cols-3 gap-3" id="ratio-selector">
                    <div>
                        <input type="radio" name="ratio-mode" value="1:1" id="ratio-1-1" class="hidden" checked>
                        <label for="ratio-1-1" class="radio-label">1:1</label>
                    </div>
                    <div>
                        <input type="radio" name="ratio-mode" value="16:9" id="ratio-16-9" class="hidden">
                        <label for="ratio-16-9" class="radio-label">16:9</label>
                    </div>
                    <div>
                        <input type="radio" name="ratio-mode" value="9:16" id="ratio-9-16" class="hidden">
                        <label for="ratio-9-16" class="radio-label">9:16</label>
                    </div>
                    <div>
                        <input type="radio" name="ratio-mode" value="4:3" id="ratio-4-3" class="hidden">
                        <label for="ratio-4-3" class="radio-label">4:3</label>
                    </div>
                    <div>
                        <input type="radio" name="ratio-mode" value="3:4" id="ratio-3-4" class="hidden">
                        <label for="ratio-3-4" class="radio-label">3:4</label>
                    </div>
                </fieldset>
            </div>
            
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-300 mb-3">生成尺寸</label>
                <fieldset class="grid grid-cols-2 gap-3" id="sample-size-selector">
                    <div>
                        <input type="radio" name="sample-size-mode" value="1024" id="size-1k" class="hidden" checked>
                        <label for="size-1k" class="radio-label">1K (1024px)</label>
                    </div>
                    <div>
                        <input type="radio" name="sample-size-mode" value="2048" id="size-2k" class="hidden">
                        <label for="size-2k" class="radio-label">2K (2048px)</label>
                    </div>
                </fieldset>
                 <p class="text-xs text-gray-500 mt-2" id="sample-size-note">注意：生成 2K 圖片會生成的更慢。</p>
            </div>
        </div>
    </div>


    <script>
        // 設定 API 端點
        const firebaseFunctionUrl = "/api/generate";

        let uploadedImage = null; 
        let sessionHistory = []; // 修改：改用全域的歷史紀錄陣列
        let currentImageIndex = 0; // 這個 index 現在對應 sessionHistory
        let isLoading = false;
        let progressInterval = null;
        
        let selectedMode = "generate-default"; 
        let selectedAspectRatio = "1:1"; 
        let selectedSampleSize = "1024"; 
        let selectedUpscaleLevel = "2048"; 

        const appContainer = document.getElementById('app-container');
        const inputHub = document.getElementById('input-hub');
        const promptTextarea = document.getElementById('prompt-textarea');
        const sendBtn = document.getElementById('send-btn');
        
        const uploadBtn1 = document.getElementById('upload-btn-1');
        const imageUpload1 = document.getElementById('image-upload-1');
        
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreviewWrapper1 = document.getElementById('image-preview-wrapper-1');
        const imagePreview1 = document.getElementById('image-preview-1');
        const removeImageBtns = document.querySelectorAll('.remove-image-btn');

        // 移除舊進度條變數
        // const progressContainer = document.getElementById('progress-container');
        // const progressBar = document.getElementById('progress-bar');
        
        // 新進度條變數
        const generationLoader = document.getElementById('generation-loader');
        const progressRing = document.getElementById('progress-ring');
        const progressPercent = document.getElementById('progress-percent');
        const CIRCUMFERENCE = 2 * Math.PI * 40; // r=40, 2*PI*r ~= 251.327

        const errorMessage = document.getElementById('error-message');

        const resultsGallery = document.getElementById('results-gallery');
        const resultImage = document.getElementById('result-image');
        const imageLoader = document.getElementById('image-loader'); // 新增：Loading 遮罩
        const downloadBtn = document.getElementById('download-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        
        const galleryNav = document.getElementById('gallery-nav');
        const navLeft = document.getElementById('nav-left');
        const navRight = document.getElementById('nav-right');
        const imageCounter = document.getElementById('image-counter');
        const historyGalleryList = document.getElementById('history-gallery-list'); // 新增：縮圖列表
        const clearHistoryBtn = document.getElementById('clear-history-btn'); // 新增：清除按鈕

        const fullscreenModal = document.getElementById('fullscreen-modal');
        const modalImage = document.getElementById('modal-image');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalDownloadBtn = document.getElementById('modal-download-btn');
        const modalNavLeft = document.getElementById('modal-nav-left');
        const modalNavRight = document.getElementById('modal-nav-right');
        
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const settingsCloseBtn = document.getElementById('settings-close-btn');
        const imageCountInput = document.getElementById('image-count');
        const imageCountWrapper = document.getElementById('image-count-wrapper'); 
        const imageCountNote = document.getElementById('image-count-note');
        const modeSelector = document.getElementById('mode-selector'); 
        const upscaleOptionsWrapper = document.getElementById('upscale-options-wrapper'); 
        const upscaleLevelSelector = document.getElementById('upscale-level-selector'); 

        const ratioBtn = document.getElementById('ratio-btn');
        const ratioModal = document.getElementById('ratio-modal');
        const ratioCloseBtn = document.getElementById('ratio-close-btn');
        const ratioSelector = document.getElementById('ratio-selector');
        const sampleSizeSelector = document.getElementById('sample-size-selector'); 
        const sampleSizeNote = document.getElementById('sample-size-note');
        
        // Metadata Elements
        const metaSize = document.getElementById('meta-size');
        const metaRatio = document.getElementById('meta-ratio');
        const metaPrompt = document.getElementById('meta-prompt');

        promptTextarea.addEventListener('input', () => {
            promptTextarea.style.height = 'auto'; 
            promptTextarea.style.height = `${promptTextarea.scrollHeight}px`;
        });

        uploadBtn1.addEventListener('click', () => imageUpload1.click());
        imageUpload1.addEventListener('change', (e) => handleImageUpload(e, 1));

        removeImageBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.previewId;
                if (id === '1') {
                    uploadedImage = null;
                    imagePreview1.src = "";
                    imagePreviewWrapper1.classList.add('hidden');
                }
                
                if (imagePreviewWrapper1.classList.contains('hidden')) {
                    imagePreviewContainer.classList.add('hidden');
                }
            });
        });

        sendBtn.addEventListener('click', handleGeneration);
        promptTextarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleGeneration();
            }
        });

        settingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        settingsCloseBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));

        modeSelector.addEventListener('change', (e) => {
            if (e.target.name === 'generation-mode') {
                selectedMode = e.target.value;
                updateInputUI();
            }
        });
        
        upscaleLevelSelector.addEventListener('change', (e) => {
            if (e.target.name === 'upscale-level-mode') {
                selectedUpscaleLevel = e.target.value;
            }
        });

        navLeft.addEventListener('click', () => showImage(currentImageIndex - 1));
        navRight.addEventListener('click', () => showImage(currentImageIndex + 1));
        
        fullscreenBtn.addEventListener('click', openFullscreen);
        modalCloseBtn.addEventListener('click', closeFullscreen);
        modalNavLeft.addEventListener('click', () => showModalImage(currentImageIndex - 1));
        modalNavRight.addEventListener('click', () => showModalImage(currentImageIndex + 1));

        downloadBtn.addEventListener('click', downloadCurrentImage);
        modalDownloadBtn.addEventListener('click', downloadCurrentImage);

        ratioBtn.addEventListener('click', () => ratioModal.classList.remove('hidden'));
        ratioCloseBtn.addEventListener('click', () => ratioModal.classList.add('hidden'));
        
        ratioSelector.addEventListener('change', (e) => {
            if (e.target.name === 'ratio-mode') {
                selectedAspectRatio = e.target.value;
            }
        });
        
        sampleSizeSelector.addEventListener('change', (e) => {
            if (e.target.name === 'sample-size-mode') {
                selectedSampleSize = e.target.value;
            }
        });

        clearHistoryBtn.addEventListener('click', clearHistory); // 綁定清除按鈕

        function updateInputUI() {
            const size2kRadio = document.getElementById('size-2k');
            const size2kLabel = size2kRadio.nextElementSibling;

            if (selectedMode === 'upscale') {
                imageCountWrapper.classList.add('hidden'); 
                upscaleOptionsWrapper.classList.remove('hidden'); 
                ratioBtn.disabled = true; 
                ratioBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                imageCountWrapper.classList.remove('hidden'); 
                upscaleOptionsWrapper.classList.add('hidden'); 
                ratioBtn.disabled = false; 
                ratioBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                imageCountInput.max = 4;
                if (parseInt(imageCountInput.value) > 4) {
                    imageCountInput.value = 4;
                }
                imageCountNote.textContent = "注意：所有模型一次最多生成 4 張。";

                size2kRadio.disabled = false;
                size2kLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                size2kLabel.title = "";
                sampleSizeNote.textContent = "注意：生成 2K 圖片會生成的更慢。";
            }
        }

        async function handleImageUpload(e, id) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const { base64Data, mimeType, previewUrl } = await imageToBase64(file);
                
                if (id === 1) {
                    uploadedImage = { base64Data, mimeType, filename: file.name };
                    imagePreview1.src = previewUrl;
                    imagePreviewWrapper1.classList.remove('hidden');
                } 
                
                imagePreviewContainer.classList.remove('hidden');
                e.target.value = null; 
            } catch (error) {
                console.error("圖片讀取錯誤:", error);
                showError("讀取圖片失敗。");
            }
        }

        async function handleGeneration() {
            if (isLoading) return;
            
            const prompt = promptTextarea.value.trim();
            let numImages = parseInt(imageCountInput.value) || 1;
            
            const mode = selectedMode;
            
            if (mode.startsWith('generate-') && (numImages < 1 || numImages > 4)) {
                showError("圖片數量必須是 1 到 4 之間的整數。");
                imageCountInput.value = Math.max(1, Math.min(numImages, 4)); 
                return; 
            }

            let aspectRatio = document.querySelector('input[name="ratio-mode"]:checked').value;
            let sampleImageSize = document.querySelector('input[name="sample-size-mode"]:checked').value;
            let upscaleLevel = document.querySelector('input[name="upscale-level-mode"]:checked').value;


            if (mode.startsWith('generate-') && !prompt && !uploadedImage) {
                showError("請至少輸入提示詞或上傳一張圖片。"); return;
            }
            if (mode === 'upscale' && !uploadedImage) {
                showError("請上傳一張圖片來進行「圖片放大」。"); return;
            }
            
            if (mode === 'upscale') {
                numImages = 1;
            }

            setLoading(true);
            await simulateProgress(0, 90, 2000); 

            try {
                const payload = {
                    mode: mode,
                    prompt: prompt,
                    numImages: numImages,
                    image: uploadedImage,       
                    aspectRatio: aspectRatio,   
                    sampleImageSize: sampleImageSize, 
                    upscaleLevel: upscaleLevel 
                };

                const result = await fetchWithBackoff(firebaseFunctionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (result.images && result.images.length > 0) {
                    // 重要修改：將新圖片附加到歷史紀錄，而不是覆蓋
                    sessionHistory = [...sessionHistory, ...result.images];
                    
                    // 渲染縮圖列表
                    renderGallery();
                    
                    // 顯示最新生成的第一張 (即剛剛加入歷史紀錄的第一張)
                    // 計算新圖片在 sessionHistory 中的起始索引
                    const newImagesStartIndex = sessionHistory.length - result.images.length;
                    
                    // 先切換到結果檢視模式
                    resultsGallery.classList.remove('hidden');
                    if (sessionHistory.length > 1) {
                        galleryNav.classList.remove('hidden');
                    } else {
                        galleryNav.classList.add('hidden');
                    }
                    
                    // 顯示新生成的圖片
                    showImage(newImagesStartIndex);
                    
                } else {
                    throw new Error("後端未回傳任何圖片。");
                }

                await simulateProgress(90, 100, 300); 
                setLoading(false);

            } catch (error) {
                console.error("後端呼叫失敗:", error);
                showError(`呼叫失敗: ${error.message}`);
                setLoading(false);
            }
        }

        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    let errorData;
                    const errorText = await response.text(); 
                    try {
                        errorData = JSON.parse(errorText); 
                    } catch (e) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText || 'Unknown Status'} - ${errorText || 'No error body'}`);
                    }
                    
                    const message = errorData.error?.message || errorData.message || response.statusText || 'Unknown error';
                    if (!message || message.trim() === "") {
                        throw new Error(`HTTP ${response.status} - ${errorText}`);
                    }
                    throw new Error(message);
                }
                
                return await response.json();

            } catch (error) {
                console.warn(`Fetch 失敗 (重試 ${retries} 次): ${error.message}`);
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }

        function imageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const previewUrl = reader.result;
                    const base64String = previewUrl.split(',')[1];
                    const mimeType = previewUrl.split(',')[0].split(':')[1].split(';')[0];
                    resolve({ 
                        base64Data: base64String, 
                        mimeType: mimeType, 
                        previewUrl: previewUrl 
                    });
                };
                reader.onerror = error => reject(error);
            });
        }

        // 新增：渲染縮圖列表
        function renderGallery() {
            historyGalleryList.innerHTML = ''; // 清空列表
            
            sessionHistory.forEach((imgData, index) => {
                const url = typeof imgData === 'string' ? imgData : imgData.url;
                
                const thumbBtn = document.createElement('button');
                thumbBtn.className = `flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 transition ${index === currentImageIndex ? 'border-blue-500 ring-2 ring-blue-500/50' : 'border-transparent hover:border-gray-500'}`;
                thumbBtn.onclick = () => showImage(index);
                
                const thumbImg = document.createElement('img');
                thumbImg.src = url;
                thumbImg.className = "w-full h-full object-cover";
                
                thumbBtn.appendChild(thumbImg);
                historyGalleryList.appendChild(thumbBtn);
            });
            
            // 自動捲動到最右邊 (最新圖片)
            setTimeout(() => {
                historyGalleryList.scrollLeft = historyGalleryList.scrollWidth;
            }, 100);
        }

        // 新增：清除歷史紀錄
        function clearHistory() {
            if (sessionHistory.length === 0) return;
            
            const currentImg = sessionHistory[currentImageIndex];
            // 只保留當前正在看的那張圖片
            sessionHistory = [currentImg];
            currentImageIndex = 0;
            
            renderGallery();
            showImage(0);
        }

        function showImage(index) {
            if (index < 0 || index >= sessionHistory.length) {
                return;
            }
            
            // 如果點擊的是同一張圖，不需要重新載入動畫
            // 但如果是第一次載入（currentImageIndex 初始值可能造成問題），則忽略此檢查
            const isSameImage = index === currentImageIndex && !imageLoader.classList.contains('hidden');
            
            currentImageIndex = index;
            
            const imgData = sessionHistory[index];
            const url = typeof imgData === 'string' ? imgData : imgData.url;

            // 1. 立即隱藏舊圖片並顯示 Loading 遮罩
            if (!isSameImage) {
                resultImage.style.opacity = '0';
                imageLoader.classList.remove('hidden');
            }
            
            // 2. 設定新圖片來源
            // 使用 Image 物件預載入，確保圖片真的抓到了再顯示
            const tempImg = new Image();
            tempImg.src = url;
            
            tempImg.onload = () => {
                // 圖片載入完成後
                resultImage.src = url;
                modalImage.src = url;
                
                // 隱藏 Loading，顯示圖片 (淡入)
                imageLoader.classList.add('hidden');
                // 稍微延遲讓 DOM 更新，觸發 CSS transition
                requestAnimationFrame(() => {
                    resultImage.style.opacity = '1';
                });
            };

            // 更新 Metadata 顯示
            if (typeof imgData === 'object') {
                metaSize.textContent = imgData.size || "Unknown";
                metaRatio.textContent = imgData.aspectRatio || "Custom";
                metaPrompt.textContent = imgData.prompt || "No Prompt";
                metaPrompt.style.display = imgData.prompt && imgData.prompt.trim() !== "" ? "block" : "none";
            }

            // 更新計數器 (現在是針對整個歷史紀錄)
            imageCounter.textContent = `${index + 1} / ${sessionHistory.length}`;
            
            navLeft.disabled = index === 0;
            navRight.disabled = index === (sessionHistory.length - 1);
            modalNavLeft.disabled = index === 0;
            modalNavRight.disabled = index === (sessionHistory.length - 1);
            
            // 更新縮圖列表的選取狀態
            const thumbnails = historyGalleryList.querySelectorAll('button');
            thumbnails.forEach((btn, idx) => {
                if (idx === index) {
                    btn.classList.add('border-blue-500', 'ring-2', 'ring-blue-500/50');
                    btn.classList.remove('border-transparent');
                    // 確保選中的縮圖在視野內
                    btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    btn.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500/50');
                    btn.classList.add('border-transparent');
                }
            });
        }

        function showModalImage(index) {
            // Modal 內的切換邏輯保持簡單，直接呼叫主函式同步狀態
            showImage(index);
        }

        function openFullscreen() {
            // showModalImage(currentImageIndex); // 不需要額外呼叫，showImage 已同步 url
            fullscreenModal.classList.remove('hidden');
            fullscreenModal.classList.add('flex');
        }

        function closeFullscreen() {
            fullscreenModal.classList.add('hidden');
            fullscreenModal.classList.remove('flex');
        }

        async function downloadCurrentImage() {
            try {
                const imgData = sessionHistory[currentImageIndex];
                const imageUrl = typeof imgData === 'string' ? imgData : imgData.url;
                
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                
                const a = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                a.href = url;
                const extension = blob.type.split('/')[1] || 'png';
                a.download = `generated-image-${Date.now()}.${extension}`;
                
                document.body.appendChild(a);
                a.click();
                
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error("下載失敗:", error);
                showError("圖片下載失敗。");
            }
        }

        function setLoading(state) {
            isLoading = state;
            sendBtn.disabled = state;
            if (state) {
                appContainer.style.justifyContent = 'flex-start'; 
                inputHub.classList.add('mt-auto'); 
                
                // 顯示結果區域 (如果是第一張，這裡會是空的，但會顯示 Loader)
                resultsGallery.classList.remove('hidden');
                
                // 顯示圓環 Loader
                generationLoader.classList.remove('hidden');
                
                errorMessage.classList.add('hidden');
                sendBtn.innerHTML = '<svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            } else {
                clearInterval(progressInterval);
                // 隱藏圓環 Loader
                generationLoader.classList.add('hidden');
                
                if (sessionHistory.length === 0) {
                    // 如果沒有任何圖片 (失敗)，隱藏畫廊
                    resultsGallery.classList.add('hidden');
                    appContainer.style.justifyContent = 'center';
                    inputHub.classList.remove('mt-auto');
                }
                
                sendBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>';
            }
        }

        function simulateProgress(start, end, duration) {
            return new Promise(resolve => {
                clearInterval(progressInterval);
                let current = start;
                const step = (end - start) / (duration / 50); 
                
                progressInterval = setInterval(() => {
                    current += step;
                    if (current >= end) {
                        current = end;
                        clearInterval(progressInterval);
                        resolve();
                    }
                    
                    // 更新圓環進度
                    // 總長度 CIRCUMFERENCE，offset 從 CIRCUMFERENCE 降到 0 為滿
                    const offset = CIRCUMFERENCE - (current / 100) * CIRCUMFERENCE;
                    progressRing.style.strokeDashoffset = offset;
                    progressPercent.textContent = `${Math.floor(current)}%`;
                    
                }, 50);
            });
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            generationLoader.classList.add('hidden');
            // 如果只有錯誤沒有圖片，隱藏畫廊
            if(sessionHistory.length === 0) {
                resultsGallery.classList.add('hidden');
                appContainer.style.justifyContent = 'center';
            }
        }

        updateInputUI();
    </script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('ServiceWorker 註冊成功:', registration.scope);
            })
            .catch(error => {
              console.log('ServiceWorker 註冊失敗:', error);
            });
        });
      }
    </script>
</body>
</html>