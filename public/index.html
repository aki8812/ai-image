<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image</title> 
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon/icon-512x512.png">

    <link rel="icon" href="favicon.ico" /> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        html, body {
            min-height: 100vh;
        }
        body {
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        /* 原本的過渡效果 */
        #app-container {
            transition: justify-content 0.5s ease-in-out;
            width: 100%; 
        }
        #prompt-textarea {
            transition: height 0.2s ease-in-out;
            scrollbar-width: none; 
        }
        #prompt-textarea::-webkit-scrollbar {
            display: none; 
        }
        /* 隱藏縮圖列的捲軸 */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .image-transition {
            transition: opacity 0.4s ease-in-out;
        }
        
        /* 自定義 Radio 樣式 */
        input[type="radio"]:checked + .radio-label {
            background-color: #3B82F6; color: #FFFFFF; border-color: #2563EB;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        input[type="radio"]:focus-visible + .radio-label {
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
             outline: none;
        }
        
        .radio-label {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            background-color: #374151; 
            color: #D1D5DB; 
            border: 1px solid #4B5563; 
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%; 
            text-align: center; 
        }

        /* 載入動畫 */
        .loading-pulse { animation: pulse-bg 1.5s infinite; }
        @keyframes pulse-bg {
            0% { background-color: #1f2937; }
            50% { background-color: #374151; }
            100% { background-color: #1f2937; }
        }

        /* 更多尺寸選單的動畫 */
        .dropdown-enter {
            transform: scale(0.95); opacity: 0; pointer-events: none;
        }
        .dropdown-enter-active {
            transform: scale(1); opacity: 1; pointer-events: auto; transition: all 0.1s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200"> 

    <!-- 修正：加入 mx-auto 強制水平置中，移除 transition-all 以免干擾原本 CSS -->
    <div id="app-container" class="w-full max-w-2xl min-h-screen flex flex-col items-center justify-center p-4 mx-auto"> 

        <!-- 結果展示區 -->
        <div id="results-gallery" class="w-full mb-4 hidden flex flex-col gap-4"> 
            <div id="image-display-wrapper" class="relative w-full max-h-[60vh] aspect-square bg-gray-800 rounded-2xl shadow-xl overflow-hidden group mx-auto flex items-center justify-center"> 
                <!-- 生成進度圓環 -->
                <div id="generation-loader" class="absolute inset-0 flex flex-col items-center justify-center z-30 bg-black/60 backdrop-blur-sm hidden transition-opacity duration-300">
                    <div class="relative w-24 h-24">
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="40" fill="transparent" stroke="#374151" stroke-width="8"></circle>
                            <circle id="progress-ring" cx="50" cy="50" r="40" fill="transparent" stroke="#3B82F6" stroke-width="8" stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"></circle>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="progress-percent" class="text-white text-lg font-bold font-mono">0%</span>
                        </div>
                    </div>
                    <p class="text-white mt-4 font-bold text-lg animate-pulse tracking-wider">AI 繪圖中...</p>
                </div>

                <!-- 圖片載入動畫 -->
                <div id="image-loader" class="absolute inset-0 flex flex-col items-center justify-center z-10 loading-pulse hidden">
                    <svg class="animate-spin h-10 w-10 text-blue-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-gray-400 text-sm">影像傳輸中...</span>
                </div>

                <img id="result-image" src="" alt="生成的圖片" class="w-full h-full object-contain image-transition opacity-0 z-0">

                <!-- 懸浮資訊層 -->
                <div class="absolute top-0 left-0 w-full p-3 flex justify-between items-start opacity-0 group-hover:opacity-100 transition-opacity bg-gradient-to-b from-black/70 to-transparent z-20 pointer-events-none">
                    <div class="flex flex-col gap-1 text-xs text-white max-w-[70%] drop-shadow-md pointer-events-auto">
                        <div class="flex gap-2 flex-wrap">
                            <span id="meta-model" class="bg-indigo-600/80 px-2 py-0.5 rounded backdrop-blur-sm font-bold"></span>
                            <span id="meta-size" class="bg-gray-700/80 px-2 py-0.5 rounded backdrop-blur-sm"></span>
                            <span id="meta-ratio" class="bg-gray-700/80 px-2 py-0.5 rounded backdrop-blur-sm"></span>
                        </div>
                        <p id="meta-prompt" class="line-clamp-2 italic opacity-90 font-light mt-1"></p>
                    </div>
                    <div class="flex gap-2 pointer-events-auto">
                        <button id="download-btn" class="bg-black/50 text-white rounded-full p-2 hover:bg-black/75 transition backdrop-blur-sm"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
                        <button id="fullscreen-btn" class="bg-black/50 text-white rounded-full p-2 hover:bg-black/75 transition backdrop-blur-sm"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg></button>
                    </div>
                </div>
            </div>

            <!-- 歷史縮圖 -->
            <div id="history-gallery-section" class="w-full flex items-center gap-3 bg-gray-800/50 p-2 rounded-xl backdrop-blur-sm border border-gray-700">
                <button id="clear-history-btn" class="flex-shrink-0 p-2.5 bg-red-900/30 hover:bg-red-900/60 text-red-200 rounded-lg transition border border-red-900/30"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></button>
                <div class="h-8 w-[1px] bg-gray-700"></div>
                <div id="history-gallery-list" class="flex gap-2 overflow-x-auto scrollbar-hide w-full items-center"></div>
            </div>
            
            <div id="gallery-nav" class="flex justify-between items-center px-2">
                <button id="nav-left" class="p-2 rounded-full hover:bg-gray-800 transition disabled:opacity-30"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <span id="image-counter" class="text-sm text-gray-400 font-mono"></span>
                <button id="nav-right" class="p-2 rounded-full hover:bg-gray-800 transition disabled:opacity-30"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
            </div>
        </div>
        
        <p id="error-message" class="w-full text-center text-red-400 mt-2 hidden bg-red-900/20 p-2 rounded-lg text-sm"></p>

        <div id="input-hub" class="w-full"> 
            <!-- 多圖預覽區 -->
            <div id="image-preview-container" class="flex gap-2 mb-2 ml-14 hidden overflow-x-auto scrollbar-hide pb-1"></div>
            
            <div class="w-full bg-gray-800 border border-gray-700 rounded-2xl shadow-lg flex items-start p-2 gap-2 relative">
                <!-- 上傳按鈕：圖示改為加號 -->
                <button id="upload-btn-1" class="flex-shrink-0 p-3 rounded-full hover:bg-gray-700 transition relative" title="上傳參考圖">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span id="upload-count-badge" class="absolute -top-1 -right-1 bg-blue-600 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
                </button>
                <input type="file" id="image-upload-1" accept="image/png, image/jpeg, image/webp" class="hidden" multiple>
                
                <!-- 比例按鈕：圖示改為正方形 -->
                <button id="ratio-btn" class="flex-shrink-0 p-3 rounded-full hover:bg-gray-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg></button>
                
                <!-- 設定按鈕 -->
                <button id="settings-btn" class="flex-shrink-0 p-3 rounded-full hover:bg-gray-700 transition" title="設定生成模式">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>

                <textarea id="prompt-textarea" rows="1" placeholder="輸入提示詞..." class="flex-grow bg-transparent text-lg text-gray-100 placeholder-gray-500 p-3 resize-none outline-none overflow-y-auto" style="max-height: 200px;"></textarea>
                
                <button id="send-btn" class="flex-shrink-0 bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="fullscreen-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 hidden transition-opacity">
        <div class="relative w-full h-full max-w-4xl max-h-[90vh] flex items-center justify-center">
            <button id="modal-close-btn" class="absolute -top-2 -right-2 md:top-2 md:right-2 z-10 bg-white text-black rounded-full p-1.5"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <img id="modal-image" src="" class="max-w-full max-h-full object-contain rounded-lg">
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md"> 
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">設定</h2>
                <button id="settings-close-btn" class="p-1 rounded-full hover:bg-gray-700"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-3">生成模式</label>
                <fieldset class="grid grid-cols-1 gap-3" id="mode-selector">
                    <!-- 新增 NanoBanana Pro 並設為預設 -->
                    <div>
                        <input type="radio" name="generation-mode" value="generate-nanobanana" id="mode-nanobanana" class="hidden" checked>
                        <label for="mode-nanobanana" class="radio-label border-l-4 border-l-yellow-500">NanoBanana Pro (預設)</label>
                    </div>
                    <div>
                        <input type="radio" name="generation-mode" value="generate-default" id="mode-default" class="hidden">
                        <label for="mode-default" class="radio-label">Imagen 4.0 (標準)</label>
                    </div>
                    <div>
                        <input type="radio" name="generation-mode" value="generate-fast" id="mode-fast" class="hidden">
                        <label for="mode-fast" class="radio-label">Imagen 4.0 (高速)</label>
                    </div>
                    <div>
                        <input type="radio" name="generation-mode" value="generate-ultra" id="mode-ultra" class="hidden">
                        <label for="mode-ultra" class="radio-label">Imagen 4.0 (Ultra)</label>
                    </div>
                    <div>
                        <input type="radio" name="generation-mode" value="upscale" id="mode-upscale" class="hidden">
                        <label for="mode-upscale" class="radio-label">圖片放大</label>
                    </div>
                </fieldset>
            </div>

            <div class="mb-4" id="image-count-wrapper">
                <label class="block text-sm font-medium text-gray-300 mb-2">生成數量 (1-4)</label>
                <input type="number" id="image-count" value="1" min="1" max="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white">
            </div>
            
            <div class="mb-4 hidden" id="upscale-options-wrapper">
                <!-- Upscale options... -->
            </div>
        </div>
    </div>
    
    <!-- Ratio Modal -->
    <div id="ratio-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">尺寸與比例</h2>
                <button id="ratio-close-btn" class="p-1 rounded-full hover:bg-gray-700"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            
            <div class="mb-4 relative">
                <label class="block text-sm font-medium text-gray-300 mb-3">長寬比例</label>
                <fieldset class="grid grid-cols-3 gap-3" id="ratio-selector">
                    <div><input type="radio" name="ratio-mode" value="1:1" id="ratio-1-1" class="hidden" checked><label for="ratio-1-1" class="radio-label">1:1</label></div>
                    <div><input type="radio" name="ratio-mode" value="16:9" id="ratio-16-9" class="hidden"><label for="ratio-16-9" class="radio-label">16:9</label></div>
                    <div><input type="radio" name="ratio-mode" value="9:16" id="ratio-9-16" class="hidden"><label for="ratio-9-16" class="radio-label">9:16</label></div>
                    <div><input type="radio" name="ratio-mode" value="4:3" id="ratio-4-3" class="hidden"><label for="ratio-4-3" class="radio-label">4:3</label></div>
                    <div><input type="radio" name="ratio-mode" value="3:4" id="ratio-3-4" class="hidden"><label for="ratio-3-4" class="radio-label">3:4</label></div>
                    
                    <!-- 更多尺寸按鈕 -->
                    <div class="relative" id="more-ratios-wrapper">
                        <button id="more-ratios-btn" class="w-full h-full bg-gray-700 text-gray-300 border border-gray-600 rounded-lg hover:bg-gray-600 transition flex items-center justify-center gap-1">
                            <span>更多...</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>
                        <!-- 下拉選單 -->
                        <div id="more-ratios-dropdown" class="absolute top-full left-0 right-0 mt-2 bg-gray-900 border border-gray-600 rounded-xl shadow-xl z-20 hidden dropdown-enter grid grid-cols-2 gap-1 p-2">
                            <input type="radio" name="ratio-mode" value="3:2" id="ratio-3-2" class="hidden"><label for="ratio-3-2" class="radio-label text-xs py-2">3:2</label>
                            <input type="radio" name="ratio-mode" value="2:3" id="ratio-2-3" class="hidden"><label for="ratio-2-3" class="radio-label text-xs py-2">2:3</label>
                            <input type="radio" name="ratio-mode" value="4:5" id="ratio-4-5" class="hidden"><label for="ratio-4-5" class="radio-label text-xs py-2">4:5</label>
                            <input type="radio" name="ratio-mode" value="5:4" id="ratio-5-4" class="hidden"><label for="ratio-5-4" class="radio-label text-xs py-2">5:4</label>
                            <input type="radio" name="ratio-mode" value="21:9" id="ratio-21-9" class="hidden col-span-2"><label for="ratio-21-9" class="radio-label text-xs py-2">21:9 (電影)</label>
                        </div>
                    </div>
                </fieldset>
            </div>
            
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-300 mb-3">生成尺寸</label>
                <!-- 注意：這裡改用 flex 以便動態插入 4K 選項 -->
                <fieldset class="flex gap-3" id="sample-size-selector">
                    <div class="flex-1"><input type="radio" name="sample-size-mode" value="1024" id="size-1k" class="hidden" checked><label for="size-1k" class="radio-label">1K</label></div>
                    <div class="flex-1"><input type="radio" name="sample-size-mode" value="2048" id="size-2k" class="hidden"><label for="size-2k" class="radio-label">2K</label></div>
                    <!-- 4K 選項 (預設隱藏) -->
                    <div class="flex-1 hidden" id="size-4k-wrapper"><input type="radio" name="sample-size-mode" value="4096" id="size-4k" class="hidden"><label for="size-4k" class="radio-label font-bold text-yellow-400">4K</label></div>
                </fieldset>
                 <p class="text-xs text-gray-500 mt-2" id="sample-size-note"></p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "/api/generate";
        
        let uploadedImages = []; 
        let sessionHistory = []; 
        let currentImageIndex = 0;
        let isLoading = false;
        let progressInterval = null;
        
        let selectedMode = "generate-nanobanana"; 
        let selectedAspectRatio = "1:1"; 
        let selectedSampleSize = "1024"; 
        let selectedUpscaleLevel = "2048"; 

        const promptTextarea = document.getElementById('prompt-textarea');
        const imageUploadInput = document.getElementById('image-upload-1');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const uploadCountBadge = document.getElementById('upload-count-badge');
        
        const modeSelector = document.getElementById('mode-selector');
        const size4kWrapper = document.getElementById('size-4k-wrapper');
        const moreRatiosWrapper = document.getElementById('more-ratios-wrapper'); // 取得更多尺寸按鈕的容器
        const moreRatiosBtn = document.getElementById('more-ratios-btn');
        const moreRatiosDropdown = document.getElementById('more-ratios-dropdown');
        
        const resultImage = document.getElementById('result-image');
        const imageLoader = document.getElementById('image-loader');
        const generationLoader = document.getElementById('generation-loader');
        const progressRing = document.getElementById('progress-ring');
        const progressPercent = document.getElementById('progress-percent');
        const CIRCUMFERENCE = 2 * Math.PI * 40; 

        const metaModel = document.getElementById('meta-model');
        const metaSize = document.getElementById('meta-size');
        const metaRatio = document.getElementById('meta-ratio');
        const metaPrompt = document.getElementById('meta-prompt');

        updateInputUI();

        document.getElementById('upload-btn-1').onclick = () => imageUploadInput.click();
        imageUploadInput.onchange = handleFilesUpload;
        
        document.getElementById('send-btn').onclick = handleGeneration;
        promptTextarea.onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleGeneration(); }};

        document.getElementById('settings-btn').onclick = () => document.getElementById('settings-modal').classList.remove('hidden');
        document.getElementById('settings-close-btn').onclick = () => document.getElementById('settings-modal').classList.add('hidden');
        document.getElementById('ratio-btn').onclick = () => document.getElementById('ratio-modal').classList.remove('hidden');
        document.getElementById('ratio-close-btn').onclick = () => document.getElementById('ratio-modal').classList.add('hidden');

        moreRatiosBtn.onclick = (e) => {
            e.stopPropagation(); 
            const isHidden = moreRatiosDropdown.classList.contains('hidden');
            if (isHidden) {
                moreRatiosDropdown.classList.remove('hidden');
                setTimeout(() => moreRatiosDropdown.classList.add('dropdown-enter-active'), 10);
            } else {
                moreRatiosDropdown.classList.remove('dropdown-enter-active');
                setTimeout(() => moreRatiosDropdown.classList.add('hidden'), 100);
            }
        };
        document.addEventListener('click', (e) => {
            if (!moreRatiosBtn.contains(e.target)) {
                moreRatiosDropdown.classList.remove('dropdown-enter-active');
                setTimeout(() => moreRatiosDropdown.classList.add('hidden'), 100);
            }
        });

        modeSelector.addEventListener('change', (e) => {
            if (e.target.name === 'generation-mode') {
                selectedMode = e.target.value;
                updateInputUI();
                validateUploads(); 
            }
        });

        document.querySelectorAll('input[name="ratio-mode"]').forEach(input => {
            input.addEventListener('change', (e) => {
                selectedAspectRatio = e.target.value;
                if (e.target.closest('#more-ratios-dropdown')) {
                    moreRatiosBtn.querySelector('span').textContent = selectedAspectRatio;
                    moreRatiosBtn.classList.add('border-blue-500', 'text-blue-400');
                } else {
                    moreRatiosBtn.querySelector('span').textContent = "更多...";
                    moreRatiosBtn.classList.remove('border-blue-500', 'text-blue-400');
                }
            });
        });
        document.querySelectorAll('input[name="sample-size-mode"]').forEach(input => {
            input.addEventListener('change', (e) => selectedSampleSize = e.target.value);
        });

        async function handleFilesUpload(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            uploadedImages = [];
            imagePreviewContainer.innerHTML = '';
            
            for (const file of files) {
                try {
                    const { base64Data, mimeType, previewUrl } = await imageToBase64(file);
                    uploadedImages.push({ base64Data, mimeType, previewUrl, size: file.size });
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = "relative w-16 h-16 flex-shrink-0 group";
                    wrapper.innerHTML = `
                        <img src="${previewUrl}" class="w-full h-full object-cover rounded-lg border border-gray-600">
                        <button class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px]" onclick="removeImage(${uploadedImages.length - 1})">&times;</button>
                    `;
                    imagePreviewContainer.appendChild(wrapper);
                } catch (err) {
                    console.error(err);
                }
            }
            
            validateUploads();
            imageUploadInput.value = ''; 
        }

        window.removeImage = function(index) {
            uploadedImages.splice(index, 1);
            imagePreviewContainer.innerHTML = '';
            uploadedImages.forEach((img, idx) => {
                const wrapper = document.createElement('div');
                wrapper.className = "relative w-16 h-16 flex-shrink-0 group";
                wrapper.innerHTML = `
                    <img src="${img.previewUrl}" class="w-full h-full object-cover rounded-lg border border-gray-600">
                    <button class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px]" onclick="removeImage(${idx})">&times;</button>
                `;
                imagePreviewContainer.appendChild(wrapper);
            });
            validateUploads();
        };

        function validateUploads() {
            const isNanoBanana = selectedMode === 'generate-nanobanana';
            const maxFiles = isNanoBanana ? 14 : 1;
            const maxTotalSize = isNanoBanana ? 20 * 1024 * 1024 : 10 * 1024 * 1024; 
            
            const totalSize = uploadedImages.reduce((acc, img) => acc + img.size, 0);
            const count = uploadedImages.length;

            uploadCountBadge.textContent = count;
            uploadCountBadge.classList.toggle('hidden', count === 0);
            imagePreviewContainer.classList.toggle('hidden', count === 0);

            const sendBtn = document.getElementById('send-btn');
            const errorMsg = document.getElementById('error-message');
            
            if (count > 0) {
                if (count > maxFiles) {
                    showError(`圖片數量過多！目前模式最多支援 ${maxFiles} 張。`);
                    sendBtn.disabled = true;
                    return;
                }
                if (totalSize > maxTotalSize) {
                    showError(`圖片總大小超過限制！目前模式上限為 ${maxTotalSize / 1024 / 1024}MB。`);
                    sendBtn.disabled = true;
                    return;
                }
            }
            
            errorMsg.classList.add('hidden');
            sendBtn.disabled = false;
        }

        function updateInputUI() {
            const isUpscale = selectedMode === 'upscale';
            const isNanoBanana = selectedMode === 'generate-nanobanana';
            const isImagen = selectedMode.startsWith('generate') && !isNanoBanana;
            
            // 4K 選項控制：只有 NanoBanana 顯示
            if (isNanoBanana) {
                size4kWrapper.classList.remove('hidden');
                // 顯示更多尺寸按鈕
                moreRatiosWrapper.classList.remove('invisible');
            } else {
                size4kWrapper.classList.add('hidden');
                // 如果是 Imagen 系列，隱藏更多尺寸按鈕 (用 invisible 佔位，避免排版跑掉，或 hidden 完全隱藏)
                // 這裡選用 invisible 讓版面一致，或者 hidden 讓剩下的按鈕變大？
                // 根據需求是 "隱藏"，通常用 hidden，但上面是 grid，hidden 會留空或遞補
                // 為了不讓使用者選到不支援的比例，我們直接隱藏
                if (isImagen) {
                    moreRatiosWrapper.classList.add('invisible'); 
                    // 如果目前選中了更多選單裡的比例，強制切回 1:1
                    const currentRatio = document.querySelector('input[name="ratio-mode"]:checked').value;
                    if (!['1:1', '16:9', '9:16', '4:3', '3:4'].includes(currentRatio)) {
                        document.getElementById('ratio-1-1').click();
                    }
                } else {
                    moreRatiosWrapper.classList.remove('invisible');
                }

                if (document.getElementById('size-4k').checked) {
                    document.getElementById('size-1k').click();
                }
            }

            document.getElementById('image-count-wrapper').classList.toggle('hidden', isUpscale);
            document.getElementById('upscale-options-wrapper').classList.toggle('hidden', !isUpscale);
            
            // 修正：Upscale 模式下禁用更多按鈕
            if(isUpscale) {
                 moreRatiosBtn.disabled = true;
                 moreRatiosBtn.classList.add('opacity-50');
            } else {
                 moreRatiosBtn.disabled = false;
                 moreRatiosBtn.classList.remove('opacity-50');
            }
        }

        async function handleGeneration() {
            if (isLoading) return;
            const prompt = promptTextarea.value.trim();
            const numImages = document.getElementById('image-count').value;

            if (selectedMode !== 'upscale' && !prompt && uploadedImages.length === 0) {
                return showError("請輸入提示詞或上傳圖片");
            }

            setLoading(true);
            await simulateProgress(0, 90, 2000); 

            try {
                const imagesPayload = uploadedImages.map(img => ({
                    base64Data: img.base64Data,
                    mimeType: img.mimeType
                }));

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: selectedMode,
                        prompt: prompt,
                        numImages: numImages,
                        images: imagesPayload, 
                        aspectRatio: selectedAspectRatio,
                        sampleImageSize: selectedSampleSize,
                        upscaleLevel: selectedUpscaleLevel
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                if (!data.images || data.images.length === 0) throw new Error("未生成圖片");

                sessionHistory = [...sessionHistory, ...data.images];
                renderGallery();
                
                const newIndex = sessionHistory.length - data.images.length;
                document.getElementById('results-gallery').classList.remove('hidden');
                showImage(newIndex);

                await simulateProgress(90, 100, 300); 
            } catch (error) {
                showError(error.message);
            } finally {
                setLoading(false);
            }
        }

        function showImage(index) {
            if (index < 0 || index >= sessionHistory.length) return;
            const isSameImage = index === currentImageIndex && !imageLoader.classList.contains('hidden');
            currentImageIndex = index;
            const imgData = sessionHistory[index];
            const url = typeof imgData === 'string' ? imgData : imgData.url;

            if (!isSameImage) {
                resultImage.style.opacity = '0';
                imageLoader.classList.remove('hidden');
            }

            const tempImg = new Image();
            tempImg.src = url;
            tempImg.onload = () => {
                resultImage.src = url;
                document.getElementById('modal-image').src = url;
                imageLoader.classList.add('hidden');
                requestAnimationFrame(() => resultImage.style.opacity = '1');
            };

            if (typeof imgData === 'object') {
                metaModel.textContent = getModelDisplayName(imgData.mode);
                metaSize.textContent = imgData.size || "Unknown";
                metaRatio.textContent = imgData.aspectRatio || "Custom";
                metaPrompt.textContent = imgData.prompt || "No Prompt";
                metaPrompt.style.display = imgData.prompt ? "block" : "none";
            }
            
            document.getElementById('image-counter').textContent = `${index + 1} / ${sessionHistory.length}`;
            updateGallerySelection(index);
        }

        function getModelDisplayName(mode) {
            if (mode === 'generate-nanobanana') return 'NanoBanana Pro';
            if (mode === 'generate-default') return 'Imagen 4.0';
            if (mode === 'generate-fast') return 'Imagen 4.0 Fast';
            if (mode === 'generate-ultra') return 'Imagen 4.0 Ultra';
            return 'AI Model';
        }

        function renderGallery() {
            const list = document.getElementById('history-gallery-list');
            list.innerHTML = '';
            sessionHistory.forEach((img, idx) => {
                const btn = document.createElement('button');
                btn.className = `flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border-2 transition ${idx === currentImageIndex ? 'border-blue-500' : 'border-transparent hover:border-gray-500'}`;
                btn.onclick = () => showImage(idx);
                const i = document.createElement('img');
                i.src = typeof img === 'string' ? img : img.url;
                i.className = "w-full h-full object-cover";
                btn.appendChild(i);
                list.appendChild(btn);
            });
            setTimeout(() => list.scrollLeft = list.scrollWidth, 100);
        }
        
        function updateGallerySelection(index) {
            const btns = document.getElementById('history-gallery-list').querySelectorAll('button');
            btns.forEach((btn, idx) => {
                if (idx === index) {
                    btn.classList.add('border-blue-500', 'ring-2', 'ring-blue-500/50');
                    btn.classList.remove('border-transparent');
                    btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    btn.classList.remove('border-blue-500', 'ring-2', 'ring-blue-500/50');
                    btn.classList.add('border-transparent');
                }
            });
        }

        document.getElementById('clear-history-btn').onclick = () => {
            if (sessionHistory.length === 0) return;
            sessionHistory = [sessionHistory[currentImageIndex]];
            currentImageIndex = 0;
            renderGallery();
            showImage(0);
        };

        function imageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({ base64Data: reader.result.split(',')[1], mimeType: file.type, previewUrl: reader.result });
                reader.onerror = reject;
            });
        }
        function setLoading(state) {
            isLoading = state;
            const btn = document.getElementById('send-btn');
            btn.disabled = state;
            if (state) {
                document.getElementById('results-gallery').classList.remove('hidden');
                generationLoader.classList.remove('hidden');
                document.getElementById('error-message').classList.add('hidden');
                btn.innerHTML = '<svg class="animate-spin h-6 w-6" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            } else {
                clearInterval(progressInterval);
                generationLoader.classList.add('hidden');
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>';
            }
        }
        function simulateProgress(start, end, duration) {
            return new Promise(resolve => {
                clearInterval(progressInterval);
                let current = start;
                const step = (end - start) / (duration / 50); 
                progressInterval = setInterval(() => {
                    current += step;
                    if (current >= end) { current = end; clearInterval(progressInterval); resolve(); }
                    const offset = CIRCUMFERENCE - (current / 100) * CIRCUMFERENCE;
                    progressRing.style.strokeDashoffset = offset;
                    progressPercent.textContent = `${Math.floor(current)}%`;
                }, 50);
            });
        }
        function showError(msg) {
            const el = document.getElementById('error-message');
            el.textContent = msg;
            el.classList.remove('hidden');
            generationLoader.classList.add('hidden');
        }
        async function downloadCurrentImage() {
            const img = sessionHistory[currentImageIndex];
            const url = typeof img === 'string' ? img : img.url;
            const a = document.createElement('a');
            a.href = url;
            a.download = `nanobanana-${Date.now()}.png`; 
            a.click();
        }
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('/service-worker.js').catch(() => {}));
      }
    </script>
</body>
</html>